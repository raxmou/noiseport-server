# Wizard Configuration Directory

This directory stores configuration files generated by the NoisePort setup wizard.

## Purpose

The wizard-config directory serves as a dedicated location for persisting wizard-generated configuration files to the host system. This approach:

1. **Preserves Built Frontend**: By not mounting the entire project root, the frontend built during Docker image creation is not overwritten
2. **Persists Configuration**: Config files are saved to the host for reuse and inspection
3. **Enables ComposeRunner**: The wizard can launch the full stack using these persisted configs

## Generated Files

When you use the setup wizard, the following files are created in this directory:

### `.env`
Environment configuration file containing all service credentials and settings:
- Navidrome connection details
- Jellyfin connection details  
- Spotify API credentials
- Soulseek/slskd credentials
- Music path configuration
- Feature toggles

### `docker-compose.full.yml`
Generated Docker Compose file for the full music stack, created from the template with your specific configuration (music paths, etc.)

### `slskd/slskd.yml`
Soulseek daemon configuration file with your Soulseek network credentials

### `headscale/config/config.yaml`
Headscale VPN server configuration file with your server URL and network settings (generated if Headscale is enabled)

### `headscale/data/`
Headscale data directory containing database and private keys (created when Headscale is enabled)

### `start-music-stack.sh`
Executable shell script to start the full music stack with your configuration

### `launch_services.log`
Log file containing output from service launch operations

## Usage

### Running the Wizard

```bash
# Start the wizard container
docker compose -f docker-compose.wizard.yml up -d

# Access the wizard at http://localhost:8000/wizard
```

### Starting the Music Stack

After configuring through the wizard, you can start the full stack in two ways:

**Option 1: Using the wizard interface**
- Click the "Launch Services" button in the wizard

**Option 2: Using the generated script**
```bash
# From the project root
./wizard-config/start-music-stack.sh
```

**Option 3: Using docker compose directly**
```bash
# From the project root
docker compose -f wizard-config/docker-compose.full.yml up -d
```

## Docker Volume Mapping

The wizard container mounts this directory at `/app/wizard-config`:

```yaml
volumes:
  - ./wizard-config:/app/wizard-config
```

This selective mounting strategy ensures:
- ✅ Config files are persisted to the host
- ✅ Built frontend is served from the Docker image
- ✅ No source code conflicts during development
- ✅ ComposeRunner can access configs to launch containers

## Development vs Production

### Development Mode (`docker-compose.dev.yml`)
In development mode, both source code AND wizard-config are mounted:
- Source code mounted for hot-reload
- wizard-config mounted for config persistence
- Frontend assets still served from image (unless overridden by local build)

### Production/Wizard Mode (`docker-compose.wizard.yml`)
In wizard/production mode, ONLY wizard-config is mounted:
- No source code mounts
- Frontend served exclusively from Docker image
- Config persisted to wizard-config

## Cleaning Up

To remove generated configuration:

```bash
# Remove all generated files (keeps .gitkeep)
rm -f wizard-config/.env wizard-config/docker-compose.full.yml \
      wizard-config/slskd.yml wizard-config/start-music-stack.sh \
      wizard-config/launch_services.log

# Or remove everything including directory (will need to recreate)
rm -rf wizard-config/
mkdir wizard-config
echo "# Config directory" > wizard-config/.gitkeep
```

## Troubleshooting

### Config files not appearing

1. Check wizard container logs:
   ```bash
   docker logs noiseport-wizard
   ```

2. Verify the volume mount:
   ```bash
   docker inspect noiseport-wizard | grep wizard-config
   ```

3. Check file permissions:
   ```bash
   ls -la wizard-config/
   ```

### ComposeRunner can't find configs

1. Ensure wizard-config is properly mounted
2. Check that files were successfully generated
3. Verify Docker socket is accessible: `docker ps`

### Services won't start

1. Check the launch log:
   ```bash
   cat wizard-config/launch_services.log
   ```

2. Validate the compose file:
   ```bash
   docker compose -f wizard-config/docker-compose.full.yml config
   ```

## Headscale VPN Setup

If you enable Headscale in the wizard, the following will be configured:

### What is Headscale?

Headscale is a self-hosted, open-source implementation of the Tailscale control server. It creates a secure VPN network for accessing your NoisePort services remotely without relying on third-party services.

### Generated Headscale Files

- `headscale/config/config.yaml` - Main Headscale server configuration
- `headscale/data/db.sqlite` - Headscale database
- `headscale/data/private.key` - Server encryption key
- `headscale/data/noise_private.key` - Noise protocol key

### Headscale Quick Start

After launching the services with Headscale enabled:

1. **Access Headplane UI**: `http://localhost:3000`
2. **Create a user/namespace**:
   ```bash
   docker exec headscale headscale users create myuser
   ```

3. **Generate an API key** (required for Headplane):
   ```bash
   docker exec headscale headscale apikeys create --expiration 0
   ```
   Update the API key in the wizard or `.env` file with the generated key.

4. **Create a pre-auth key** for connecting devices:
   ```bash
   docker exec headscale headscale preauthkeys create --user myuser --reusable --expiration 24h
   ```

5. **Connect devices**: Install Tailscale client on your devices and configure them to use your Headscale server URL with the pre-auth key.

### Headscale Services

When Headscale is enabled, two additional services are included:
- **Headscale** (port 8080): VPN coordination server
- **Headplane** (port 3000): Web UI for managing Headscale

### Setup Modes

- **Domain-based**: Use a domain name with HTTPS (recommended for production)
  - Requires: domain name, DNS A record, SSL certificate
  - Example: `https://headscale.yourdomain.com`

- **IP-based**: Use server IP directly (simpler for testing)
  - Requires: server IP address (local or public)
  - Example: `http://192.168.1.100:8080`

For more details, see the [Headscale documentation](https://headscale.net/).

## Security Note

This directory contains sensitive configuration including:
- Service passwords
- API credentials
- Authentication tokens
- Headscale API keys and encryption keys

**Do not commit these files to version control!** The `.gitignore` is configured to exclude all files except `.gitkeep`.
